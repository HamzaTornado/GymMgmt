services:
  # 1. Your .NET Web API
  gym-api:
    image: gym-mgmt-api
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Note: Consider using ${SA_PASSWORD} for better security instead of hardcoding
      - ConnectionStrings__DefaultConnection=Server=gym-db;Database=GymMasterDb;User Id=sa;Password=Gymdb2025@2025;TrustServerCertificate=True;
      - JWT__Secret=${JWT_SECRET}
      - JWT__Issuer=${DOMAIN_NAME}
      - JWT__Audience=${DOMAIN_NAME}
      - JWT__TokenValidityInMinutes=60
      - JWT__RefreshTokenValidityInMinutes=1440
      - AppConfig__CorsOrigins=${DOMAIN_NAME},http://localhost:5173,https://localhost:7077
      - AppConfig__ApiVirtualPath=${DOMAIN_NAME}
    depends_on:
      - gym-db
    restart: always
    networks:
      - proxy_net   # connects to the internet (via Proxy Manager)
      - internal_net # connects to the database

  # 2. SQL Server Database
  gym-db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Gymdb2025@2025
    volumes:
      - sql_data:/var/opt/mssql
    restart: always
    networks:
      - internal_net # Only accessible by the API, safe from the internet!

  # REMOVED: The manual 'nginx' service. 
  # Nginx Proxy Manager is already running separately and handles Port 80.

networks:
  proxy_net:
    external: true  # This network must already exist (docker network create proxy_net)
  internal_net:     # This creates a private link between API and DB